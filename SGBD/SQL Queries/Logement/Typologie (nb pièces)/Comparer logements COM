-- Exemple de Vitrolles avec DEP et REG 

WITH territories AS (
  -- Vitrolles
  SELECT
    'Vitrolles' as territoire,
    SUM(P21_RP_1P) as t1,
    SUM(P21_RP_2P) as t2,
    SUM(P21_RP_3P) as t3,
    SUM(P21_RP_4P) as t4,
    SUM(P21_RP_5PP) as t5,
    SUM(P21_RP) as total_logements
  FROM Principaux_indicateurs_COM_2021
  WHERE CODGEO = '13117'

  UNION ALL

  -- Bouches-du-Rhône
  SELECT
    'Bouches-du-Rhône' as territoire,
    SUM(P21_RP_1P) as t1,
    SUM(P21_RP_2P) as t2,
    SUM(P21_RP_3P) as t3,
    SUM(P21_RP_4P) as t4,
    SUM(P21_RP_5PP) as t5,
    SUM(P21_RP) as total_logements
  FROM Principaux_indicateurs_COM_2021
  WHERE CODGEO IN ('13001', '13002', '13003', '13004', '13005', '13006', '13007', '13008', '13009', '13010', '13011', '13012', '13013', '13014', '13015', '13016', '13017', '13018', '13019', '13020', '13021', '13022', '13023', '13024', '13025', '13026', '13027', '13028', '13029', '13030', '13031', '13032', '13033', '13034', '13035', '13036', '13037', '13038', '13039', '13040', '13041', '13042', '13043', '13044', '13045', '13046', '13047', '13048', '13049', '13050', '13051', '13052', '13053', '13054', '13055', '13056', '13057', '13058', '13059', '13060', '13061', '13062', '13063', '13064', '13065', '13066', '13067', '13068', '13069', '13070', '13071', '13072', '13073', '13074', '13075', '13076', '13077', '13078', '13079', '13080', '13081', '13082', '13083', '13084', '13085', '13086', '13087', '13088', '13089', '13090', '13091', '13092', '13093', '13094', '13095', '13096', '13097', '13098', '13099', '13100', '13101', '13102', '13103', '13104', '13105', '13106', '13107', '13108', '13109', '13110', '13111', '13112', '13113', '13114', '13115', '13116', '13117', '13118', '13119')

  UNION ALL

  -- PACA
  SELECT
    'PACA' as territoire,
    SUM(P21_RP_1P) as t1,
    SUM(P21_RP_2P) as t2,
    SUM(P21_RP_3P) as t3,
    SUM(P21_RP_4P) as t4,
    SUM(P21_RP_5PP) as t5,
    SUM(P21_RP) as total_logements
  FROM Principaux_indicateurs_COM_2021
  WHERE CODGEO IN ('04001', '04004', '04005', '04006', '04007', '04008', '04009', '04012', '04013', '04016', '04017', '04018', '04019', '04020', '04021', '04022', '04023', '04024', '04025', '04026', '04027', '04028', '04030', '04031', '04032', '04033', '04034', '04035', '04036', '04037', '04039', '04040', '04041', '04042', '04043', '04045', '04046', '04047', '04049', '04050', '04051', '04053', '04054', '04055', '04057', '04058', '04059', '04061', '04062', '04063', '04065', '04066', '04067', '04068', '04069', '04070', '04072', '04073', '04074', '04075', '04076', '04077', '04079', '04081', '04084', '04085', '04086', '04087', '04088', '04090', '04091', '04092', '04093', '04094', '04095', '04096', '04097', '04099', '04101', '04102', '04104', '04106', '04107', '04108', '04109', '04110', '04111', '04112', '04113', '04115', '04116', '04118', '04120', '04121', '04122', '04123', '04124', '04126', '04127', '04128', '04129', '04130', '04132', '04133', '04134', '04135', '04136', '04137', '04138', '04139', '04140', '04141', '04142', '04143', '04144', '04145', '04148', '04149', '04150', '04151', '04152', '04154', '04155', '04156', '04157', '04158', '04159', '04160', '04161', '04162', '04163', '04164', '04166', '04167', '04169', '04170', '04171', '04172', '04173', '04174', '04175', '04176', '04177', '04178', '04179', '04180', '04181', '04182', '04183', '04184', '04186', '04187', '04188', '04189', '04190', '04191', '04192', '04193', '04194', '04195', '04197', '04199', '04200', '04201', '04202', '04203', '04204', '04205', '04206', '04207', '04208', '04209', '04210', '04211', '04214', '04216', '04217', '04218', '04219', '04220', '04222', '04224', '04226', '04227', '04228', '04229', '04230', '04231', '04233', '04234', '04235', '04236', '04237', '04240', '04241', '04242', '04244', '04245', '05001', '05003', '05004', '05006', '05007', '05008', '05009', '05010', '05011', '05012', '05013', '05014', '05016', '05017', '05018', '05019', '05021', '05022', '05023', '05024', '05025', '05026', '05027', '05028', '05029', '05031', '05032', '05033', '05035', '05036', '05037', '05038', '05039', '05040', '05044', '05045', '05046', '05047', '05048', '05049', '05050', '05051', '05052', '05053', '05054', '05055', '05056', '05057', '05058', '05059', '05060', '05061', '05062', '05063', '05064', '05065', '05066', '05068', '05070', '05071', '05072', '05073', '05074', '05075', '05076', '05077', '05078', '05079', '05080', '05081', '05082', '05084', '05085', '05086', '05087', '05089', '05090', '05091', '05092', '05093', '05094', '05095', '05096', '05097', '05098', '05099', '05100', '05101', '05102', '05103', '05104', '05106', '05107', '05108', '05109', '05110', '05111', '05112', '05113', '05114', '05115', '05116', '05117', '05118', '05119', '05121', '05122', '05123', '05124', '05126', '05127', '05128', '05129', '05130', '05131', '05132', '05133', '05134', '05135', '05136', '05139', '05140', '05142', '05144', '05145', '05146', '05147', '05148', '05149', '05151', '05152', '05153', '05154', '05155', '05156', '05157', '05158', '05159', '05160', '05161', '05162', '05163', '05164', '05165', '05166', '05167', '05168', '05169', '05170', '05171', '05172', '05173', '05174', '05176', '05177', '05178', '05179', '05180', '05181', '05182', '05183', '05184')
)

SELECT 
  territoire,
  ROUND(CAST(t1 AS FLOAT) / total_logements, 3) as "T1",
  ROUND(CAST(t2 AS FLOAT) / total_logements, 3) as "T2",
  ROUND(CAST(t3 AS FLOAT) / total_logements, 3) as "T3",
  ROUND(CAST(t4 AS FLOAT) / total_logements, 3) as "T4",
  ROUND(CAST(t5 AS FLOAT) / total_logements, 3) as "T5 ou plus"
FROM territories
ORDER BY 
  CASE territoire
    WHEN 'Vitrolles' THEN 1
    WHEN 'Bouches-du-Rhône' THEN 2
    WHEN 'PACA' THEN 3
  END;